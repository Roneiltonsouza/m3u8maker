<script>
    const modal = document.getElementById('authModal');
    const modalContent = document.getElementById('modalContent');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const appContent = document.getElementById('appContent');
    const viewerOverlay = document.getElementById('viewerOverlay');
    const fullImage = document.getElementById('fullImage');
    const photoGrid = document.getElementById('photoGrid');
    const fileInput = document.getElementById('fileInput');

    // --- AUTENTICAÇÃO ---
    function openModal(type) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('modal-active'), 10);
        if (type === 'register') {
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center">Criar Conta</h2><input type="email" id="email" placeholder="Seu e-mail" class="w-full p-4 mb-4 rounded-xl bg-white/10 border border-white/20 outline-none focus:border-red-500 text-white"><input type="password" id="pin" maxlength="4" placeholder="PIN de 4 dígitos" class="w-full p-4 mb-6 rounded-xl bg-white/10 border border-white/20 outline-none focus:border-red-500 text-center text-xl tracking-widest text-white"><button onclick="handleAuth('register')" class="w-full bg-red-600 hover:bg-red-700 p-4 rounded-xl font-bold transition">CADASTRAR</button>`;
        } else {
            modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center">Login</h2><input type="email" id="email" placeholder="E-mail" class="w-full p-4 mb-4 rounded-xl bg-white/10 border border-white/20 outline-none focus:border-red-500 text-white"><input type="password" id="pin" maxlength="4" placeholder="PIN" class="w-full p-4 mb-6 rounded-xl bg-white/10 border border-white/20 outline-none focus:border-red-500 text-center text-xl text-white"><button onclick="handleAuth('login')" class="w-full bg-white text-black p-4 rounded-xl font-bold hover:bg-gray-200 transition">ENTRAR</button>`;
        }
    }

    function closeModal() {
        modal.classList.remove('modal-active');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function handleAuth(mode) {
        const email = document.getElementById('email').value.toLowerCase();
        const pin = document.getElementById('pin').value;
        if (!email.includes('@') || pin.length < 4) { alert("E-mail inválido ou PIN curto demais."); return; }
        
        if (mode === 'register') {
            if (localStorage.getItem(email)) { alert("E-mail já cadastrado."); } 
            else { localStorage.setItem(email, pin); loginUser(email); }
        } else {
            if (localStorage.getItem(email) === pin) { loginUser(email); } 
            else { alert("Dados incorretos."); }
        }
    }

    function loginUser(email) {
        localStorage.setItem('currentUser', email);
        welcomeScreen.classList.add('hidden');
        closeModal();
        appContent.classList.remove('hidden-app');
        loadPhotos(); // Carrega as fotos ao logar
    }

    function logout() {
        if(confirm("Deseja sair da sua conta?")) {
            localStorage.removeItem('currentUser');
            location.reload();
        }
    }

    function deleteAccount() {
        const email = localStorage.getItem('currentUser');
        if (confirm(`Atenção: Deseja APAGAR a conta e todos os dados?`)) {
            localStorage.removeItem(email);
            localStorage.removeItem(`photos_${email}`);
            localStorage.removeItem('currentUser');
            location.reload();
        }
    }

    // --- VISUALIZAÇÃO ---
    function viewImage(src) {
        fullImage.src = src;
        viewerOverlay.style.display = 'flex';
    }

    function closeViewer() {
        viewerOverlay.style.display = 'none';
    }

    // --- LOGICA DE FOTOS (PERMANÊNCIA) ---

    // 1. Carregar fotos do LocalStorage
    function loadPhotos() {
        const email = localStorage.getItem('currentUser');
        const savedPhotos = JSON.parse(localStorage.getItem(`photos_${email}`)) || [];
        photoGrid.innerHTML = ''; // Limpa antes de carregar
        savedPhotos.forEach(photoData => {
            createPhotoElement(photoData);
        });
    }

    // 2. Salvar foto no LocalStorage
    function savePhotoToStorage(base64Data) {
        const email = localStorage.getItem('currentUser');
        const savedPhotos = JSON.parse(localStorage.getItem(`photos_${email}`)) || [];
        savedPhotos.push(base64Data);
        localStorage.setItem(`photos_${email}`, JSON.stringify(savedPhotos));
    }

    // 3. Excluir foto permanentemente
    function deletePhoto(button, imgSrc) {
        if(confirm("Excluir esta foto permanentemente?")) {
            const email = localStorage.getItem('currentUser');
            let savedPhotos = JSON.parse(localStorage.getItem(`photos_${email}`)) || [];
            
            // Remove do array do LocalStorage
            savedPhotos = savedPhotos.filter(photo => photo !== imgSrc);
            localStorage.setItem(`photos_${email}`, JSON.stringify(savedPhotos));
            
            // Remove do HTML
            button.parentElement.remove();
        }
    }

    // 4. Criar o elemento visual da foto
    function createPhotoElement(src) {
        const div = document.createElement('div');
        div.className = "relative group rounded-2xl aspect-square overflow-hidden shadow-xl border border-white/10 bg-black";
        div.innerHTML = `
            <img src="${src}" onclick="viewImage('${src}')" class="w-full h-full object-cover cursor-zoom-in group-hover:scale-105 transition duration-500">
            <button onclick="deletePhoto(this, '${src}')" class="absolute top-2 right-2 bg-black/60 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600">
                <i class="fas fa-trash-alt text-xs"></i>
            </button>
        `;
        photoGrid.prepend(div);
    }

    // Evento de Upload
    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length > 0) {
            document.getElementById('progressContainer').classList.remove('hidden');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 25;
                document.getElementById('progressBar').style.width = progress + '%';
                if(progress >= 100) {
                    clearInterval(interval);
                    document.getElementById('progressContainer').classList.add('hidden');
                    processFiles(files);
                    document.getElementById('progressBar').style.width = '0%';
                }
            }, 150);
        }
    });

    function processFiles(files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                createPhotoElement(base64);
                savePhotoToStorage(base64);
            }
            reader.readAsDataURL(file);
        });
    }

    window.onload = () => {
        const user = localStorage.getItem('currentUser');
        if(user) loginUser(user);
    }
</script>
